# 自作キーボードキットを無線化する

BLE Micro Proを導入する手順はいくつかありますが、初めての場合は[BLE Micro Pro Web Configurator](https://sekigon-gonnoc.github.io/BLE-Micro-Pro-WebConfigurator/)を使った方法がおすすめです。

- [ハードウェアの準備](#ハードウェアの準備)
- [BLE Micro Pro Web Configuratorを使う](#ble-micro-pro-web-configuratorを使う)
  - [キーボードを選ぶ](#キーボードを選ぶ)
  - [ファームウェアのアップデート](#ファームウェアのアップデート)
  - [設定ファイルの書き込み](#設定ファイルの書き込み)
  - [キーマップの書き込み](#キーマップの書き込み)
    - [Remapを使う場合(USB/BLE接続)](#remapを使う場合usbble接続)
    - [Vialを使う場合](#vialを使う場合)
  - [ペアリングする](#ペアリングする)
    - [(分割型のみ)マスターとスレーブの接続](#分割型のみマスターとスレーブの接続)
    - [パソコン等とのペアリング](#パソコン等とのペアリング)
- [BLE Micro Pro上のファイルを直接操作する](#ble-micro-pro上のファイルを直接操作する)
  - [UF2ファイルでファームウェアをアップデートする](#uf2ファイルでファームウェアをアップデートする)
    - [ブートローダの起動](#ブートローダの起動)
    - [ファームウェアの書き込み](#ファームウェアの書き込み)
  - [設定ファイルの書き込み](#設定ファイルの書き込み-1)

## ハードウェアの準備

- BLE Micro Proを取り付ける準備
  - BLE Micro ProはPro Microの代わりに取り付けられます。
  - ピンヘッダでなくコンスルーを使う場合ははんだ付けは必要ありません([遊舎工房販売ページ](https://yushakobo.jp/shop/a01mc-00/), [TALP keyboard販売ページ](https://talpkeyboard.stores.jp/items/5e056626d790db16e2889233), [Switch Science 販売ページ](https://www.switch-science.com/catalog/3763/))
    - BLE Micro Proはコンスルー対応なのでBLE Micro Pro側はんだづけ不要です。
    - Pro Microはコンスルー非対応なので、Pro Micro側にはんだ付けが必要です。
    - 国内キーボード基板はコンスルー対応基板が多いですが、海外キーボード基板の場合は非対応の場合が多く、キーボード基板側をはんだ付けする必要があります。
  - キーボード基板に電源ピンが用意されている場合は13ピンのコンスルーが必要な場合があります。キーボードキットの必要部品をよく確認してください。
    - 7skbやKugel-1のように、USBコネクタ側に寄せてコンスルーを取り付けることで12ピンでも動作するキットもあります。
  - キーボード基板に電源ピンが用意されていない場合は12ピンのコンスルーを調達してください。
    - BLE Micro Pro対応を明示していないキーボードの場合はこちらの可能性が高いです。

- 電源の準備
  - 導入の段階ではUSBケーブルで接続をしてUSB端子から電源供給を受けるので必須ではありません。
  - 無線運用するときには電池かそれに相当するものから電源供給する必要があります。
  - BLE Micro Pro用に設計されたものとしては単4電池基板([BOOTH販売ページ](https://nogikes.booth.pm/items/2710739))またはコイン電池基板([遊舎工房販売ページ](https://yushakobo.jp/shop/ble-micro-pro-battery-board/)、[BOOTH販売ページ](https://nogikes.booth.pm/items/1655285))があります。  
    - 電池基板とBLE Micro Proの接続にはコンスルー、ピンヘッダもしくは銅線を使ってください。
    - キーボードキットによってはキーボード上に電池基板に相当する機能を取り付けられるオプションがあります。そのオプションを使う場合は電池基板は不要です。
  - 電源を自分で作る場合には[デザインガイド](design_guide.md#電源)を参照してください。


## BLE Micro Pro Web Configuratorを使う

Google Chromeから[BLE Micro Pro Web Configurator](https://sekigon-gonnoc.github.io/BLE-Micro-Pro-WebConfigurator/)にアクセスするとブラウザからファームウェアのアップデートや各種設定ができます。  

### キーボードを選ぶ

`ナビゲーション付きでセットアップを開始する`ボタンを押すとキーボードの選択画面が表示されます。
リストから無線化したいキーボードを選んでください。

無線化したいキーボードがリストにない場合には、[キーボードの設定を生成して](about_config_files.md)、ここでは`ble_micro_pro`または`ble_micro_pro_split`を選択してください。

このページでは2つのオプションが選択できます。

- Disable Mass Storage Class
  - BLE Micro Proにファームウェアを書き込むとパソコンにUSBケーブルで接続したときに大容量記憶デバイスとして認識されます。セキュリティの都合などで、大容量記憶デバイスとして認識されると困る場合にはこのオプションにチェックを入れることで機能を無効化できます。

- Use with LPME-IO（分割型のみ）
  - 分割型キーボードを無線化するときにBLE Micro Proを2台使った完全無線化をするのではなく、BLE Micro ProとLPME-IOを組み合わせた部分無線化をする場合にはこのオプションにチェックを入れてください。  
  - **LPME-IOを使用するにはキーボードの改造が必要な場合があります**

構成を選択し終わったら`Next`ボタンを押すと次の手順に進みます。

### ファームウェアのアップデート

BLE Micro Proにはブートローダとアプリケーションという2種類のファームウェアを書き込みます。

2つのファームウェアのバージョンは`<major>.<minor>.<revision>`の3つの数字の組み合わせで表されていて、ブートローダとアプリケーションのメジャーバージョンとマイナーバージョンは一致させる必要があります。

特別な事情がない限りは両方ともデフォルトで選択されている最新版を利用してください。

また、大容量記憶デバイスの無効化オプションはブートローダとアプリケーションのそれぞれで設定でき、初期設定は最初の画面で選んだとおりになっています。

アップデートしたいBLE Micro ProをUSBケーブルで接続したら、`Update`ボタンを押してください。
ブラウザの左上からCOMポートの選択画面が表示されます。
BLE Micro ProのCOMポートを選択したら`接続`ボタンを押してください。
どのポートがBLE Micro Proのものかわからない場合は、接続する前後でCOMポートのリストを比較してみてください。

ブートローダが起動したという表示が出た場合はもう一度`Update`ボタンを押します。

アップデートが始まると進捗状況が表示されます。進捗が100%になり、アップデートに成功したという表示が出たら`Next`ボタンを押して次の手順に進みます。

繰り返しになりますが、ブートローダとアプリケーションをそれぞれアップデートしてください。

### 設定ファイルの書き込み

設定ファイルの書き込み画面でもキーボードの選択リストが表示されます。
ナビゲーション付きでセットアップを開始した場合は最初に選択したキーボードとレイアウトが選択されているため、ここで選択し直す必要はありません。

最初にキーボードを選択するときに`ble_micro_pro`を選択した場合は、ここで`upload your own`を選択してください。

ここでもいくつかオプションを設定できます

- Use With LPME-IO（分割型のみ）
  - 前述の設定と同様です。デフォルトでは最初の画面で選んだ設定が引き継がれています。

- Is Slave（分割型のみ）
  - 分割型の場合、2つのBLE Micro ProにMaster/Slaveという役割が割り振られます。ナビゲーション付きでセットアップを開始した場合は手順に応じて自動的に選択されるため、変更する必要はありません。

- Is Left（分割型のみ）
  - いま設定しているBLE Micro Proを左手に取り付ける場合にはチェックを入れてください。

- Debounce
  - キー入力のチャタリング除去のパラメータです。デフォルトは1で、チャタリングがひどい場合にはチャタリングが無くなるまで1ずつ増やしてみてください。

- Connection interval(Peripheral)
  - 通信間隔の設定です。短くすると入力のラグが減る一方で、電力消費が増加します。
    - 一体型キーボード、または分割型キーボードのMasterを設定している場合はPCとの通信間隔を設定します。
    - 分割型キーボードのSlaveを設定している場合はMasterとの通信間隔を設定します。後述のMaster側の設定と合わせてください。
  
- Connection interval(Central)（分割型Masterのみ）
  - 分割型キーボードのSlaverとの通信間隔を設定します。前述のSlave側の設定と合わせてください。

オプションを設定したら`Update`ボタンを押すとシリアルポートの選択が表示され、BLE Micro Proを接続したシリアルポートを選択するとアップデートが始まります。
リストから`upload your own`を選択した場合はここでファイルの選択画面が表示されるため、用意したコンフィグファイルを選んでください。
設定が成功したら`Next`ボタンを押して次の手順に進んでください。

一体型キーボード、またはLPME-IOを使った設定をしている場合はこのままキーマップの書き換えに進みます。

分割型キーボードを完全無線化する場合はSlave側のBLE Micro Proに繋ぎ変えて同様の手順を繰り返してください。

すべてのBLE Micro Proの設定が完了したら、Master側のBLE Micro Proに再度繋ぎ変えて、キーマップの書き換えに進んでください。

### キーマップの書き込み

- 上部メニューの`Write Default Keymap`から登録されているデフォルトキーマップを書き込めます。登録されていない場合はバックアップしたEEPROM.BINをアップロードして書き込めます。
- Remap, Vialのいずれかでキーマップを変更します。
- BLE Micro Pro用に無線接続関連など[いくつかのカスタムキーコード](edit_keymap_file.md#カスタムキーコード)が組み込まれています。最低限、以下のキーコードをキーマップに設定することをおすすめします

  |キーコード|機能|
  |-|-|
  |AD_WO_L|ホストの接続、スレーブの探索を開始する。新しいデバイスとペアリングできる|
  |ADV_IDn|n番目にペアリングしたデバイスと接続しようとする|
  |SEL_USB|USB接続を経由して送信する|
  |SEL_BLE|BLE接続を経由して送信する|
  |BATT_LV|バッテリーの電圧を表示する(文字列が自動で入力されます)|
  |ENT_SLP|スリープモードに入る|

#### Remapを使う場合(USB/BLE接続)

Web Configuratorにデフォルトキーマップが設定されていない場合はすべてのキーを設定する必要があります。
Remapにキーマップが保存されている場合はSAVE/RESTORE機能をBLE Micro Pro上に復元してください。


#### Vialを使う場合

* Vialを利用する場合、ローカル版のVialでは電源投入後の初回の接続には必ず失敗してしまいます。エラーが表示されたらRefreshボタンを押して再読み込みしてください。ブラウザ版では自動でリトライされるため、再読み込みの操作は必要ありません
* 一度Vialと接続した場合、リセットするまでRemapには接続できなくなります。Remapに再接続したい場合は、リセットするか電源を再投入してください
* Remapのマクロ定義とVialのマクロ定義が異なるため、一方で編集したマクロはもう一方で正しく表示されない場合があります。どちらで定義してもマクロの実行は可能です


### ペアリングする

#### (分割型のみ)マスターとスレーブの接続

- 分割型の場合は、マスターとスレーブの起動直後にペアリングが自動で実行されます。マスター起動後速やかにスレーブを起動してください。
- パソコンとのペアリングを実行する前に、マスターをUSB接続した状態で両手とも入力できることを確認してください。

#### パソコン等とのペアリング

- `AD_WO_L`を配置したキーを押下するとBLE Micro Proがアドバタイズを開始します。その後、ペアリングしたい機器からスキャンを実行して、キーボードが表示されたら選択して登録してください。

- 2台目以降のデバイスとペアリングする場合は、他のペアリング済みデバイスのBluetoothを無効化してから`AD_WO_L`を実行してください。

- 指定したペアリング済みパソコン等に接続したい場合、`ADV_IDx`を実行します。`x`はペアリング番号(0-7)です。分割型の場合、ID0はスレーブです。

## BLE Micro Pro上のファイルを直接操作する

### UF2ファイルでファームウェアをアップデートする

#### ブートローダの起動

- キーボードのリセットボタンを押しながらUSB接続するとブートローダが起動します
- すでにキーボードとして動作する場合には[CLI](cli.md)からdfuコマンドを送信することでも起動できます  

#### ファームウェアの書き込み

拡張子が`.uf2`のファイルを使って書き込みます

- BLE Micro Proがマスストレージデバイスとして認識され、中に`INFO_UF2.TXT`があることを確認してください。このファイルがない場合、ブートローダの起動に失敗しているので再起動してください
- アップデートしたいuf2ファイルをコピーするとアップデートが始まります。アップデート中はケーブルを外さないでください
- アップデートが完了すると自動でアンマウントされます
- 再度マウントするとuf2ファイルは消えていますが、下記の方法でアップデートが完了していることを確認してください
  - ブートローダをアップデートした場合、`INFO_UF2.TXT`を開いてアップデート完了を確認してください
  - アプリケーションのアップデートの場合は`VERSION.TXT`を開いてアップデート完了を確認してください

### 設定ファイルの書き込み

BLE Micro Proがアプリケーションを起動している状態で設定ファイルをコピーすると自動的に書き込みが始まります。

|ファイル名|R/W|役割|
|-|-|-|
|CONFIG.BIN|RW|キーボードの設定やVialの設定・バックアップ用|
|DEFAULT.BIN|RW|EEPROMのデフォルト状態(デフォルトキーマップなど)の設定・バックアップ用|
|EEPROM.BIN|R|現在のEEPROM状態のバックアップ用|
|VERSION.TXT|R|現在のファームウェアのバージョン|
|VIALJSON.BIN|R|vial.jsonを7zで圧縮したバイナリのバックアップ用|
